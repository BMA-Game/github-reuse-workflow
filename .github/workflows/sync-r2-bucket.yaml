name: Sync to R2 Bucket

on:
  workflow_call:
    inputs:
      directory:
        description: "The local directory to sync from"
        required: true
        default: "dev"
        type: string
      bucket-name:
        description: "The name of the R2 bucket"
        required: true
        type: string
      r2-account-id:
        description: "Your Cloudflare R2 Account ID"
        required: true
        type: string
    secrets:
      R2_ACCESS_KEY_ID:
        description: "Your R2 Access Key ID"
        required: true
      R2_SECRET_ACCESS_KEY:
        description: "Your R2 Secret Access Key"
        required: true

jobs:
  sync-to-r2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Upload files to R2 with correct content-type
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: "auto"
        run: |
          echo "üîÑ Scanning and uploading files from '${{ inputs.directory }}' to bucket '${{ inputs.bucket-name }}'"

          find ${{ inputs.directory }} -type f | while read file; do
            rel_path="${file#${{ inputs.directory }}/}"
            extension="${file##*.}"
            extension=$(echo "$extension" | tr '[:upper:]' '[:lower:]')

            case "$extension" in
              jpg|jpeg) content_type="image/jpeg" ;;
              png) content_type="image/png" ;;
              gif) content_type="image/gif" ;;
              webp) content_type="image/webp" ;;
              svg) content_type="image/svg+xml" ;;
              *) content_type="application/octet-stream" ;;
            esac

            echo "üì§ Uploading $rel_path (type: $content_type)"

            aws s3 cp "$file" "s3://${{ inputs.bucket-name }}/$rel_path" \
              --endpoint-url "https://${{ inputs.r2-account-id }}.r2.cloudflarestorage.com" \
              --content-type "$content_type" \
              --cache-control "no-cache, must-revalidate" \
              --metadata "uploaded=$(date +%s)" \
              --quiet || echo "‚ùå Upload failed: $file"
          done

          echo "‚úÖ Sync to R2 completed."
