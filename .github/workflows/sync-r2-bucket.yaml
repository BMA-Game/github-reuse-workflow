name: Sync to R2 Bucket

on:
  workflow_call:
    inputs:
      directory:
        description: "The local directory to sync from"
        required: true
        default: "dev"
        type: string
      bucket-name:
        description: "The name of the R2 bucket"
        required: true
        type: string
      r2-account-id:
        description: "Your Cloudflare R2 Account ID"
        required: true
        type: string
    secrets:
      R2_ACCESS_KEY_ID:
        required: true
      R2_SECRET_ACCESS_KEY:
        required: true

jobs:
  discover-subdirectories:
    runs-on: 4-core-arm64-GitHub-hosted-runners
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Find subdirectories
        run: |
          cd "${{ inputs.directory }}"

          # Find all subdirectories
          subdirs=$(find . -maxdepth 1 -type d ! -name "." ! -name ".git" ! -name ".github" ! -name ".*" | sed 's|^\./||' | sort)

          # Check if there are files in the root
          root_files=$(find . -maxdepth 1 -type f ! -name ".*" | wc -l)
          has_root_files="false"
          if [ "$root_files" -gt 0 ]; then
            has_root_files="true"
          fi

          # Convert to JSON array for matrix
          if [ -n "$subdirs" ]; then
            subdir_json=$(echo "$subdirs" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            subdir_json="[]"
          fi

  sync-subdirectories:
    needs: [discover-subdirectories]
    if: ${{ fromJson(needs.discover-subdirectories.outputs.subdirs)[0] != null }}
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        subdir: ${{ fromJson(needs.discover-subdirectories.outputs.subdirs) }}
    uses: BMA-Game/github-reuse-workflow/.github/workflows/sync-r2-reusable.yaml@main
    with:
      directory: ${{ matrix.subdir }}
      bucket-name: ${{ needs.get-env.outputs.bucket_name }}
      r2-account-id: ${{ needs.get-env.outputs.r2_account_id }}
    secrets:
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
