name: Sync to R2 Bucket

on:
  workflow_call:
    inputs:
      directory:
        description: "The local directory to sync from"
        required: true
        default: "dev"
        type: string
      bucket-name:
        description: "The name of the R2 bucket"
        required: true
        type: string
      r2-account-id:
        description: "Your Cloudflare R2 Account ID"
        required: true
        type: string
    secrets:
      R2_ACCESS_KEY_ID:
        required: true
      R2_SECRET_ACCESS_KEY:
        required: true

jobs:
  discover-subdirectories:
    runs-on: 4-core-arm64-GitHub-hosted-runners
    outputs:
      subdirs: ${{ steps.find.outputs.subdirs }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find subdirectories
        id: find
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ inputs.directory }}"

          # Find top-level subdirectories (exclude dot dirs)
          mapfile -t subdirs < <(find . -maxdepth 1 -type d ! -name "." ! -name ".git" ! -name ".github" ! -name ".*" \
            | sed 's|^\./||' | sort)

          # Root files?
          root_files_count=$(find . -maxdepth 1 -type f ! -name ".*" | wc -l | tr -d '[:space:]')
          has_root_files=false
          if [ "$root_files_count" -gt 0 ]; then
            has_root_files=true
          fi

          # JSON for matrix
          if [ "${#subdirs[@]}" -gt 0 ]; then
            subdir_json=$(printf "%s\n" "${subdirs[@]}" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            subdir_json="[]"
          fi

          echo "has_root_files=${has_root_files}" >> "$GITHUB_OUTPUT"
          echo "subdirs=${subdir_json}" >> "$GITHUB_OUTPUT"

  sync-subdirectories:
    needs: [discover-subdirectories]
    if: ${{ needs.discover-subdirectories.outputs.subdirs != '' && needs.discover-subdirectories.outputs.subdirs != '[]' }}
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix:
        subdir: ${{ fromJson(needs.discover-subdirectories.outputs.subdirs || '[]') }}
    uses: BMA-Game/github-reuse-workflow/.github/workflows/sync-r2-reusable.yaml@main
    with:
      # Compose the full path to pass to the reusable workflow
      directory: ${{ format('{0}/{1}', inputs.directory, matrix.subdir) }}
      bucket-name: ${{ inputs['bucket-name'] }}
      r2-account-id: ${{ inputs['r2-account-id'] }}
      dest-prefix: ${{ matrix.subdir }}
    secrets:
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
