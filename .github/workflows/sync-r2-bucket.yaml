name: Sync to R2 Bucket

on:
  workflow_call:
    inputs:
      directory:
        description: "The local directory to sync from"
        required: true
        default: "dev"
        type: string
      bucket-name:
        description: "The name of the R2 bucket"
        required: true
        type: string
      r2-account-id:
        description: "Your Cloudflare R2 Account ID"
        required: true
        type: string
    secrets:
      R2_ACCESS_KEY_ID:
        description: "Your R2 Access Key ID"
        required: true
      R2_SECRET_ACCESS_KEY:
        description: "Your R2 Secret Access Key"
        required: true

jobs:
  sync-to-r2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install and configure rclone
        run: |
          # Install rclone
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Configure rclone for R2
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: |
          # Create rclone config for R2
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${R2_ACCESS_KEY_ID}
          secret_access_key = ${R2_SECRET_ACCESS_KEY}
          endpoint = https://${{ inputs.r2-account-id }}.r2.cloudflarestorage.com
          EOF

      - name: Sync files to R2 Bucket
        run: |
          echo "Starting sync from ${{ inputs.directory }}/ to r2:${{ inputs.bucket-name }}"
          rclone copy ${{ inputs.directory }}/ r2:${{ inputs.bucket-name }} \
            --progress \
            --delete-after \
            --header-upload "Cache-Control: public, max-age=31536000" \
            --s3-upload-cutoff 200M \
            --s3-chunk-size 100M \
            --transfers 4 \
            --checkers 8 \
            --checksum \
            --s3-no-check-bucket \
            --s3-disable-checksum \
            --retries 3 \
            --ignore-checksum \
            --size-only
          echo "Sync completed successfully"
